<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSIF Informa ‚Äî Noticias</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,Segoe UI,Helvetica,Arial,sans-serif;background:#fff;color:#222;min-height:100vh;padding-bottom:90px}
    header{background:#2e7d32;color:#fff;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .logo{font-weight:700}
    main{padding:14px}
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .filters select{padding:8px;border:1px solid #ccc;border-radius:6px;background:#fff;min-width:150px}
    footer{position:fixed;bottom:0;left:0;width:100%;background:#1b5e20;color:#fff;padding:8px 10px;text-align:center;font-size:0.78rem;z-index:999}
    .locked{display:none}
    @media(min-width:768px){.news-grid{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="logo">CSIF Noticias</div>
    <div>
      <button id="userBtn">üë§ Iniciar Sesi√≥n</button>
    </div>
  </header>

  <!-- LOGIN -->
  <div id="loginModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000;align-items:center;justify-content:center">
    <div style="background:#fff;padding:16px;border-radius:8px;max-width:360px;margin:auto">
      <h3>Iniciar sesi√≥n</h3>
      <form id="loginForm">
        <label>Usuario (DNI)</label><br>
        <input id="username" type="text" required style="width:100%;padding:8px;margin:8px 0;border:1px solid #ccc;border-radius:6px" />
        <button type="submit" style="padding:8px 12px;background:#2e7d32;color:#fff;border:none;border-radius:6px">Acceder</button>
        <div id="loginMessage" style="color:red;margin-top:8px;display:none"></div>
      </form>
    </div>
  </div>

  <!-- CONTENIDO PROTEGIDO -->
  <div id="appContent" class="locked">
    <nav id="navQuick" style="padding:10px;background:#f3f7f3;border-bottom:1px solid #e8efe8"></nav>

    <main>
      <h2 id="current-category">Todas las noticias</h2>

      <!-- FILTROS ENCANDENADOS -->
      <div class="filters">
        <div>
          <label for="categoriaSelect">Categor√≠a</label><br>
          <select id="categoriaSelect" disabled>
            <option value="">-- Cargando categor√≠as --</option>
          </select>
        </div>

        <div>
          <label for="subcategoriaSelect">Subcategor√≠a</label><br>
          <select id="subcategoriaSelect" disabled>
            <option value="">-- Selecciona categor√≠a primero --</option>
          </select>
        </div>

        <div>
          <label for="comunidadSelect">Comunidad Aut√≥noma</label><br>
          <select id="comunidadSelect" disabled>
            <option value="">-- Cargando comunidades --</option>
          </select>
        </div>

        <div>
          <label for="provinciaSelect">Provincia</label><br>
          <select id="provinciaSelect" disabled>
            <option value="">-- Selecciona comunidad primero --</option>
          </select>
        </div>
      </div>

      <div id="subnavPlaceholder" class="sub-nav"></div>
      <section id="newsSection">
        <div id="newsGrid" class="news-grid"></div>
      </section>
    </main>

    <footer>
      <div class="footer-links">
        <a style="color:#a5d6a7">Inicio</a> ¬∑ <a style="color:#a5d6a7">Contacto</a>
      </div>
      <div>&copy; 2025 CSIF</div>
    </footer>
  </div>

<script>
/* ====================================================
   APP PREPARADA PARA BASE DE DATOS / API REAL
   ==================================================== */

/* -------------------------
   FUNCIONES VAC√çAS PARA CONECTAR A TU BD / API
   Sustituye los comentarios con tu propia l√≥gica.
   ------------------------- */

async function fetchCategorias() {
  // TODO: aqu√≠ conecta con tu BD o API
  // Ejemplo:
  // const res = await fetch('/api/categorias');
  // return await res.json();
  return [];
}

async function fetchComunidades() {
  // TODO: conecta con tu BD
  // const res = await fetch('/api/comunidades');
  // return await res.json();
  return [];
}

async function fetchProvincias(comunidadId) {
  // TODO: conecta con tu BD filtrando por comunidad
  // const res = await fetch(`/api/provincias?comunidad=${comunidadId}`);
  // return await res.json();
  return [];
}

async function fetchNoticias() {
  // TODO: carga todas las noticias o filtradas desde tu BD
  // const res = await fetch('/api/noticias');
  // return await res.json();
  return [];
}

/* -------------------------
   ELEMENTOS DOM
   ------------------------- */
const categoriaSelect = document.getElementById('categoriaSelect');
const subcategoriaSelect = document.getElementById('subcategoriaSelect');
const comunidadSelect = document.getElementById('comunidadSelect');
const provinciaSelect = document.getElementById('provinciaSelect');
const newsGrid = document.getElementById('newsGrid');
const navQuick = document.getElementById('navQuick');
const subnavPlaceholder = document.getElementById('subnavPlaceholder');

/* Estado local */
let categoriasData = [];
let comunidadesData = [];
let provinciasDataMap = {};
let noticias = [];

/* -------------------------
   CARGA INICIAL
   ------------------------- */
async function initApp() {
  categoriasData = await fetchCategorias();
  comunidadesData = await fetchComunidades();
  noticias = await fetchNoticias();

  populateCategoriaSelect();
  populateComunidadSelect();
  renderNews(noticias);

  categoriaSelect.disabled = false;
  comunidadSelect.disabled = false;
  renderNavQuick();
}

/* -------------------------
   RELLENO DE SELECTS
   ------------------------- */
function populateCategoriaSelect() {
  categoriaSelect.innerHTML = '<option value="">-- Todas las categor√≠as --</option>';
  categoriasData.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat.nombre;
    opt.textContent = cat.nombre;
    categoriaSelect.appendChild(opt);
  });
}

function populateSubcategoriaSelect(categoriaNombre) {
  subcategoriaSelect.innerHTML = '<option value="">-- Todas las subcategor√≠as --</option>';
  subcategoriaSelect.disabled = true;
  const cat = categoriasData.find(c => c.nombre === categoriaNombre);
  if (!cat) return;
  cat.subcategorias.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    subcategoriaSelect.appendChild(opt);
  });
  subcategoriaSelect.disabled = false;
  renderSubnav(cat.subcategorias);
}

function populateComunidadSelect() {
  comunidadSelect.innerHTML = '<option value="">-- Todas las comunidades --</option>';
  comunidadesData.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    comunidadSelect.appendChild(opt);
  });
}

async function populateProvinciaSelect(comunidadId) {
  provinciaSelect.innerHTML = '<option value="">-- Cargando provincias --</option>';
  provinciaSelect.disabled = true;

  if (provinciasDataMap[comunidadId]) {
    fillProvinciaOptions(provinciasDataMap[comunidadId]);
    return;
  }

  const provincias = await fetchProvincias(comunidadId);
  provinciasDataMap[comunidadId] = provincias;
  fillProvinciaOptions(provincias);
}

function fillProvinciaOptions(provincias) {
  provinciaSelect.innerHTML = '<option value="">-- Todas las provincias --</option>';
  provincias.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.nombre;
    provinciaSelect.appendChild(opt);
  });
  provinciaSelect.disabled = false;
}

/* -------------------------
   NAV R√ÅPIDO Y SUBNAV
   ------------------------- */
function renderNavQuick() {
  navQuick.innerHTML = '';
  const all = document.createElement('button');
  all.textContent = "Todas";
  all.onclick = () => {
    categoriaSelect.value = "";
    subcategoriaSelect.value = "";
    comunidadSelect.value = "";
    provinciaSelect.value = "";
    filterAndShow();
  };
  navQuick.appendChild(all);

  categoriasData.forEach(cat => {
    const btn = document.createElement('button');
    btn.textContent = cat.nombre;
    btn.style.marginLeft = '8px';
    btn.onclick = () => {
      categoriaSelect.value = cat.nombre;
      populateSubcategoriaSelect(cat.nombre);
      filterAndShow();
    };
    navQuick.appendChild(btn);
  });
}

function renderSubnav(subs = []) {
  subnavPlaceholder.innerHTML = '';
  if (!subs.length) return;
  subs.forEach(s => {
    const b = document.createElement('button');
    b.textContent = s;
    b.style.marginRight = '8px';
    b.onclick = () => {
      subcategoriaSelect.value = s;
      filterAndShow();
    };
    subnavPlaceholder.appendChild(b);
  });
}

/* -------------------------
   EVENTOS
   ------------------------- */
categoriaSelect.addEventListener('change', e => {
  const cat = e.target.value;
  if (cat) {
    populateSubcategoriaSelect(cat);
  } else {
    subcategoriaSelect.innerHTML = '<option value="">-- Selecciona categor√≠a --</option>';
    subcategoriaSelect.disabled = true;
    subnavPlaceholder.innerHTML = '';
  }
  filterAndShow();
});

subcategoriaSelect.addEventListener('change', filterAndShow);
comunidadSelect.addEventListener('change', async e => {
  const comunidadId = e.target.value;
  if (comunidadId) {
    await populateProvinciaSelect(comunidadId);
  } else {
    provinciaSelect.innerHTML = '<option value="">-- Selecciona comunidad primero --</option>';
    provinciaSelect.disabled = true;
  }
  filterAndShow();
});
provinciaSelect.addEventListener('change', filterAndShow);

/* -------------------------
   FILTRO Y RENDER DE NOTICIAS
   ------------------------- */
function filterAndShow() {
  const cat = categoriaSelect.value || null;
  const sub = subcategoriaSelect.value || null;
  const comunidadId = comunidadSelect.value || null;
  const provinciaId = provinciaSelect.value || null;

  let filtered = noticias.slice();
  if (cat) filtered = filtered.filter(n => n.category === cat);
  if (sub) filtered = filtered.filter(n => n.subcategory === sub);
  if (comunidadId) filtered = filtered.filter(n => n.comunidadId === comunidadId);
  if (provinciaId) filtered = filtered.filter(n => n.provinciaId === provinciaId);

  renderNews(filtered);
}

/* -------------------------
   RENDER DE NOTICIAS
   ------------------------- */
function renderNews(list) {
  newsGrid.innerHTML = '';
  if (!list.length) {
    newsGrid.innerHTML = '<div style="padding:12px;background:#fff;border:1px solid #eee;border-radius:8px">No hay noticias con esos filtros.</div>';
    return;
  }
  list.forEach(n => {
    const card = document.createElement('article');
    card.className = 'news-card';
    card.innerHTML = `
      <img src="${n.image || 'https://via.placeholder.com/400x200'}" alt="${n.title}" loading="lazy">
      <div class="news-content">
        <strong>${n.title}</strong>
        <p style="margin-top:8px;font-size:0.95rem;color:#666">${n.excerpt || ''}</p>
        <div style="margin-top:8px;font-size:0.8rem;color:#999">${n.date || ''}</div>
      </div>`;
    newsGrid.appendChild(card);
  });
}

/* -------------------------
   LOGIN
   ------------------------- */
const users = [
  { username:"10000000A", name:"Administrador CSIF", role:"admin" },
  { username:"00000001A", name:"Mar√≠a L√≥pez", role:"Afiliado" }
];

const loginModal = document.getElementById('loginModal');
const loginForm = document.getElementById('loginForm');
const loginMessage = document.getElementById('loginMessage');
const appContent = document.getElementById('appContent');

document.getElementById('userBtn').addEventListener('click', ()=>{ loginModal.style.display='flex'; });
loginForm.onsubmit = (e) => {
  e.preventDefault();
  const uname = document.getElementById('username').value.trim();
  const user = users.find(u=>u.username===uname);
  if(user){
    localStorage.setItem('currentUser', JSON.stringify(user));
    loginModal.style.display = 'none';
    appContent.classList.remove('locked');
    initApp();
  } else {
    loginMessage.textContent = 'Usuario no v√°lido';
    loginMessage.style.display = 'block';
  }
};

const cu = localStorage.getItem('currentUser');
if(cu){
  appContent.classList.remove('locked');
  initApp();
} else {
  loginModal.style.display = 'flex';
}
</script>
</body>
</html>
